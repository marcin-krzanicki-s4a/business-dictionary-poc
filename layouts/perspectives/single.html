{{ define "main" }}
{{ $objectID := .Params.object_id }}
{{ $perspectiveID := .Params.perspective_id }}
{{ $objectData := index site.Data.objects $objectID }}
{{ $sysData := index $objectData.SystemPerspectives $perspectiveID }}

{{ if $sysData }}
<!-- Header Section -->
<div class="uk-section uk-section-xsmall uk-padding-remove-bottom">
    <div class="uk-container">

        <!-- Breadcrumbs -->
        <ul class="uk-breadcrumb uk-margin-small-bottom">
            <li><a href="{{ site.Home.RelPermalink }}">Home</a></li>
            <li><a href="{{ `objects/` | relURL }}{{ $objectID | lower }}">{{ $objectData.Name }}</a></li>
            <li><a href="{{ `perspectives` | relURL }}">Perspectives</a></li>
            <!-- <li class="uk-disabled"><span>{{ $perspectiveID }}</span></li> -->
        </ul>

        <div class="uk-flex uk-flex-middle uk-margin-medium-bottom">
            <h1 class="uk-heading-small uk-margin-remove-bottom uk-margin-right">{{ $perspectiveID }}</h1>
            {{ $status := $sysData.Status | default "Draft" }}
            <span class="uk-badge uk-padding-small"
                style="{{ if eq (lower $status) `draft` }}background-color: var(--s4a-light-violet);{{ else if eq (lower $status) `deprecated` }}background-color: #888;{{ end }}">{{
                $status }}</span>
        </div>

        <p class="uk-text-lead uk-text-muted uk-margin-remove-top uk-margin-medium-bottom">
            Category: System Perspective | Object: {{ $objectData.Name }}
        </p>
    </div>
</div>

<!-- Content Grid Section -->
<div class="uk-section uk-section-default uk-padding-small">
    <div class="uk-container">

        <div class="uk-grid-medium" uk-grid>

            <!-- Main Column -->
            <div class="uk-width-1-1">

                <!-- Context / Definition -->
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3 uk-text-primary-red">Context</h2>
                    <div class="uk-text-lead">{{ $sysData.Context }}</div>

                    {{ if $sysData.PermittedUserGroups }}
                    <h3 class="uk-h4 uk-margin-top">Permitted User Groups</h3>
                    <div>
                        {{ range $sysData.PermittedUserGroups }}
                        <span class="uk-label uk-label-secondary uk-margin-small-right">{{ . }}</span>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>

                <!-- Relevant Attributes Table -->
                {{ if $sysData.RelevantAttributes }}
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-top uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Relevant Attributes</h2>
                    <div class="uk-overflow-auto">
                        <table
                            class="uk-table uk-table-striped uk-table-hover uk-table-small uk-table-responsive uk-margin-top">
                            <thead>
                                <tr>
                                    <th class="uk-table-expand">Attribute Name</th>
                                    <th>Type</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range $sysData.RelevantAttributes }}
                                <tr>
                                    <td>
                                        {{ $attrName := .Name }}
                                        {{ $attrLink := "" }}
                                        {{ range $id, $data := site.Data.attributes }}
                                        {{ if eq (lower $data.name) (lower $attrName) }}
                                        {{ $attrLink = printf "attributes/%s" $id | relURL }}
                                        {{ end }}
                                        {{ end }}

                                        {{ if $attrLink }}
                                        <a href="{{ $attrLink }}" class="uk-link-text"
                                            style="text-decoration: underline;"><code>{{ .Name }}</code></a>
                                        {{ else }}
                                        <code>{{ .Name }}</code>
                                        {{ end }}
                                    </td>
                                    <td>{{ .Type }}</td>
                                    <td>{{ .Source }}</td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{ end }}

                <!-- System CTAs -->
                {{ if $sysData.SystemSpecificCTAs }}
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-top uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">System Actions (CTAs)</h2>
                    <ul class="uk-list uk-list-divider">
                        {{ range $sysData.SystemSpecificCTAs }}
                        <li class="uk-flex uk-flex-middle uk-flex-between">
                            <div>
                                <span class="uk-text-bold">{{ . }}</span>
                            </div>
                            <!-- <button class="uk-button uk-button-default uk-button-small">Simulate Action</button> -->
                        </li>
                        {{ end }}
                    </ul>
                </div>
                {{ end }}

                <!-- Related UI Views -->
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h3 class="uk-card-title" style="color: var(--s4a-dark-violet);">Related UI Views</h3>
                    <p class="uk-text-small uk-text-muted">Screens and interfaces associated with this perspective.</p>

                    {{ if $sysData.ViewsUsed }}
                    <div class="uk-grid-small uk-child-width-1-2@s uk-grid-match" uk-grid>
                        {{ range $sysData.ViewsUsed }}
                        {{ $viewName := .ref }}
                        {{ $viewData := index site.Data.views $viewName }}
                        {{ if $viewData }}
                        <div>
                            <a href="{{ `views/` | relURL }}{{ $viewName }}" class="uk-link-reset">
                                <div
                                    class="uk-card uk-card-default uk-card-hover uk-card-body uk-padding-small uk-height-1-1">
                                    <div class="uk-text-small uk-text-muted">UI View</div>
                                    <h4 class="uk-card-title uk-margin-small-top uk-text-small">{{ $viewName }}</h4>
                                    <p class="uk-text-meta">{{ $viewData.Platform }}</p>
                                </div>
                            </a>
                        </div>
                        {{ end }}
                        {{ end }}
                    </div>
                    {{ else }}
                    <p class="uk-text-small uk-text-muted">No specific views linked.</p>
                    {{ end }}
                </div>

                <!-- Data Lineage Map -->
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Data Lineage Map</h2>
                    <div class="mermaid">
                        graph LR
                        {{ $safePerspName := $perspectiveID | replaceRE "[()]" "" }}
                        persp["{{ $safePerspName }}"]
                        style persp fill:#f3e5f5,stroke:#7b1fa2,color:#7b1fa2,stroke-width:2px

                        %% Upstream Object
                        {{ $safeObjectName := $objectData.Name | replaceRE "[()]" "" }}
                        object["{{ $safeObjectName }}<br />(Canonical Object)"]
                        style object fill:#ffebee,stroke:#d32f2f,color:#d32f2f,stroke-width:1px
                        object -.-> persp
                        click object "{{ `objects/` | relURL }}{{ $objectID | lower }}"

                        %% Extended Attributes (Perspective Specific)
                        {{ if $sysData.RelevantAttributes }}
                        subgraph Extended Attributes
                        direction TB
                        {{ range first 5 $sysData.RelevantAttributes }}
                        {{ $attrName := .Name }}
                        {{ $safeAttrName := $attrName | replaceRE "[^a-zA-Z0-9]" "" }}
                        attr_{{ $safeAttrName }}["{{ $attrName }}"]
                        style attr_{{ $safeAttrName }} fill:#fff,stroke:#999,stroke-dasharray: 5 5
                        attr_{{ $safeAttrName }} -.-> persp
                        {{ end }}
                        {{ if gt (len $sysData.RelevantAttributes) 5 }}
                        more_attr["...and {{ sub (len $sysData.RelevantAttributes) 5 }} more"]
                        style more_attr fill:#fff,stroke:#999,stroke-dasharray: 5 5
                        more_attr -.-> persp
                        {{ end }}
                        end
                        {{ end }}

                        %% Downstream Views
                        {{ if $sysData.ViewsUsed }}
                        {{ range $sysData.ViewsUsed }}
                        {{ $viewName := .ref }}
                        {{ $safeViewName := $viewName | replaceRE "[^a-zA-Z0-9]" "" }}
                        view_{{ $safeViewName }}["{{ $viewName }}"]
                        style view_{{ $safeViewName }} fill:#e8eaf6,stroke:#303f9f,color:#303f9f,stroke-width:1px
                        persp -.-> view_{{ $safeViewName }}
                        click view_{{ $safeViewName }} "{{ `views/` | relURL }}{{ $viewName }}"
                        {{ end }}
                        {{ end }}
                    </div>
                </div>

                <script type="module">
                    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'neutral',
                        securityLevel: 'loose',
                        flowchart: { curve: 'basis' }
                    });
                </script>

            </div>
        </div>
    </div>
</div>
{{ else }}
<div class="uk-container uk-margin-large-top">
    <div class="uk-alert-danger" uk-alert>
        <p>Data for perspective <strong>{{ $perspectiveID }}</strong> not found in object <strong>{{ $objectID
                }}</strong>.</p>
    </div>
</div>
{{ end }}
{{ end }}