{{ define "main" }}
{{ $attributeID := .File.BaseFileName }}
{{ $attributeData := index site.Data.attributes $attributeID }}

{{ if $attributeData }}
<!-- Header Section -->
<div class="uk-section uk-section-xsmall uk-padding-remove-bottom">
    <div class="uk-container">

        <!-- Breadcrumbs -->
        <ul class="uk-breadcrumb uk-margin-small-bottom">
            <li><a href="{{ site.Home.RelPermalink }}">Home</a></li>
            <li><a href="{{ `attributes` | relURL }}">Attributes</a></li>
            <!-- <li><span>{{ $attributeData.name }}</span></li> -->
        </ul>

        <div class="uk-flex uk-flex-middle uk-margin-medium-bottom">
            <h1 class="uk-heading-small uk-margin-remove-bottom uk-margin-right">{{ $attributeData.name }}</h1>
            <span class="uk-badge uk-padding-small" style="background-color: var(--s4a-light-violet);">{{
                $attributeData.dataType }}</span>
        </div>

        <p class="uk-text-lead uk-text-muted uk-margin-remove-top uk-margin-medium-bottom">
            Category: Global Attribute | ID: {{ $attributeData.id }}
            {{ if $attributeData.unit }} | Unit: {{ $attributeData.unit }}{{ end }}
        </p>
    </div>
</div>

<!-- Content Grid Section -->
<div class="uk-section uk-section-default uk-padding-small">
    <div class="uk-container">

        <div class="uk-grid-medium" uk-grid>

            <!-- Main Column -->
            <div class="uk-width-1-1">

                <!-- General Information (Description + Definition) -->
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3 uk-text-primary-red">General Information</h2>

                    <!-- Description -->
                    {{ if $attributeData.description }}
                    <div class="uk-text-lead uk-margin-medium-bottom">{{ $attributeData.description }}</div>
                    {{ end }}

                    <hr class="uk-divider-icon">

                    <!-- Definition Grid -->
                    <div class="uk-grid-small uk-child-width-1-2@s uk-child-width-1-4@m" uk-grid>
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Data Type</h4>
                            <p class="uk-margin-small-top"><strong>{{ $attributeData.dataType }}</strong></p>
                        </div>

                        {{ if $attributeData.format }}
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Format</h4>
                            <p class="uk-margin-small-top"><code
                                    style="background-color: #f5f5f5; padding: 4px 8px; border-radius: 4px;">{{ $attributeData.format }}</code>
                            </p>
                        </div>
                        {{ end }}

                        {{ if $attributeData.pattern }}
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Pattern</h4>
                            <p class="uk-margin-small-top"><code
                                    style="background-color: #f5f5f5; padding: 4px 8px; border-radius: 4px;">{{ $attributeData.pattern }}</code>
                            </p>
                        </div>
                        {{ end }}

                        {{ if $attributeData.example }}
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Example</h4>
                            <p class="uk-margin-small-top"><code
                                    style="background-color: #f5f5f5; padding: 4px 8px; border-radius: 4px;">{{ $attributeData.example }}</code>
                            </p>
                        </div>
                        {{ end }}
                    </div>
                </div>

                <!-- Constraints & Validation -->
                {{ if or $attributeData.minValue $attributeData.maxValue $attributeData.minLength
                $attributeData.maxLength $attributeData.precision $attributeData.unit }}
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Constraints & Validation</h2>
                    <div class="uk-overflow-auto">
                        <table
                            class="uk-table uk-table-striped uk-table-hover uk-table-small uk-table-responsive uk-margin-top">
                            <thead>
                                <tr>
                                    <th class="uk-width-medium">Constraint</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ if or $attributeData.minValue (eq $attributeData.minValue 0) }}
                                <tr>
                                    <td><strong>Min Value</strong></td>
                                    <td>{{ $attributeData.minValue }}</td>
                                </tr>
                                {{ end }}
                                {{ if or $attributeData.maxValue (eq $attributeData.maxValue 0) }}
                                <tr>
                                    <td><strong>Max Value</strong></td>
                                    <td>{{ $attributeData.maxValue }}</td>
                                </tr>
                                {{ end }}
                                {{ if or $attributeData.minLength (eq $attributeData.minLength 0) }}
                                <tr>
                                    <td><strong>Min Length</strong></td>
                                    <td>{{ $attributeData.minLength }}</td>
                                </tr>
                                {{ end }}
                                {{ if or $attributeData.maxLength (eq $attributeData.maxLength 0) }}
                                <tr>
                                    <td><strong>Max Length</strong></td>
                                    <td>{{ $attributeData.maxLength }}</td>
                                </tr>
                                {{ end }}
                                {{ if or $attributeData.precision (eq $attributeData.precision 0) }}
                                <tr>
                                    <td><strong>Precision</strong></td>
                                    <td>{{ $attributeData.precision }}</td>
                                </tr>
                                {{ end }}
                                {{ if $attributeData.unit }}
                                <tr>
                                    <td><strong>Unit</strong></td>
                                    <td>{{ $attributeData.unit }}</td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{ end }}

                <!-- Enumeration Values -->
                {{ if $attributeData.values }}
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Allowed Values</h2>
                    <div class="uk-overflow-auto">
                        <table
                            class="uk-table uk-table-striped uk-table-hover uk-table-small uk-table-responsive uk-margin-top">
                            <thead>
                                <tr>
                                    <th class="uk-width-small">Key</th>
                                    <th class="uk-width-medium">Label</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range $attributeData.values }}
                                <tr>
                                    <td><code>{{ .key }}</code></td>
                                    <td><strong>{{ .label }}</strong></td>
                                    <td>{{ .description }}</td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{ end }}

                <!-- Data Origin & Quality (Simulated) -->
                <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
                    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Data Origin & Quality</h2>
                    <div class="uk-grid-small uk-child-width-1-2@s uk-child-width-1-4@m" uk-grid>
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Source System</h4>
                            <p class="uk-margin-small-top">
                                <span uk-icon="icon: server; ratio: 0.8" class="uk-margin-small-right"></span>
                                <strong>{{ .Params.sourceSystem }}</strong>
                            </p>
                        </div>
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Source Type</h4>
                            <p class="uk-margin-small-top">
                                <span class="uk-label" style="background-color: {{ if eq .Params.sourceType " Internal"
                                    }}var(--s4a-dark-violet){{ else }}#666{{ end }};">
                                    {{ .Params.sourceType }}
                                </span>
                            </p>
                        </div>
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Source Entity</h4>
                            <p class="uk-margin-small-top">
                                <span uk-icon="icon: database; ratio: 0.8" class="uk-margin-small-right"></span>
                                <code>{{ .Params.sourceEntity }}</code>
                            </p>
                        </div>
                        <div>
                            <h4 class="uk-text-muted uk-margin-remove-bottom">Refresh Rate</h4>
                            <p class="uk-margin-small-top">
                                <span uk-icon="icon: history; ratio: 0.8" class="uk-margin-small-right"></span>
                                {{ .Params.refreshRate }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Used In Section (Dynamic) -->
                {{ $currentAttrName := $attributeData.name }}
                {{ $usedIn := slice }}

                <!-- Scan Objects -->
                {{ range $objID, $objData := site.Data.objects }}
                {{ $found := false }}
                {{ if $objData.CoreAttributes }}
                {{ range $objData.CoreAttributes }}
                {{ if eq (lower .Name) (lower $currentAttrName) }}
                {{ $found = true }}
                {{ end }}
                {{ end }}
                {{ end }}
                {{ if $found }}
                {{ $usedIn = $usedIn | append (dict "name" $objData.Name "type" "Business Object" "link" (printf
                "objects/%s/" (lower $objID) | relURL) "icon" "file-text" "color" "var(--s4a-red)") }}
                {{ end }}
                {{ end }}

                <!-- Scan Perspectives -->
                {{ range $objID, $objData := site.Data.objects }}
                {{ if $objData.SystemPerspectives }}
                {{ range $perspID, $perspData := $objData.SystemPerspectives }}
                {{ $found := false }}
                {{ if $perspData.RelevantAttributes }}
                {{ range $perspData.RelevantAttributes }}
                {{ if eq (lower .Name) (lower $currentAttrName) }}
                {{ $found = true }}
                {{ end }}
                {{ end }}
                {{ end }}
                {{ if $found }}
                {{ $perspLink := "" }}
                {{ range where site.RegularPages "Section" "perspectives" }}
                {{ if and (eq .Params.object_id $objID) (eq .Params.perspective_id $perspID) }}
                {{ $perspLink = .RelPermalink }}
                {{ end }}
                {{ end }}
                {{ if eq $perspLink "" }}
                {{ $perspLink = printf "perspectives/%s/" ($perspID | urlize) | relURL }}
                {{ end }}
                {{ $usedIn = $usedIn | append (dict "name" $perspID "type" "Perspective" "link" $perspLink "icon"
                "album" "color" "var(--s4a-light-violet)") }}
                {{ end }}
                {{ end }}
                {{ end }}
                {{ end }}

                <!-- Scan Views -->
                {{ range $viewID, $viewData := site.Data.views }}
                {{ $found := false }}
                {{ if $viewData.IncludedAttributes }}
                {{ range $viewData.IncludedAttributes }}
                {{ $attrName := "" }}
                {{ if reflect.IsMap . }}
                {{ $attrName = .Name }}
                {{ else }}
                {{ $attrName = . }}
                {{ end }}

                {{ if eq (lower $attrName) (lower $currentAttrName) }}
                {{ $found = true }}
                {{ end }}
                {{ end }}
                {{ end }}

                {{ if $found }}
                {{ $viewPage := site.GetPage (printf "/views/%s" $viewID) }}
                {{ $viewTitle := $viewID }}
                {{ $viewLink := "" }}
                {{ if $viewPage }}
                {{ $viewTitle = $viewPage.Title }}
                {{ $viewLink = $viewPage.RelPermalink }}
                {{ else }}
                {{ $viewLink = printf "views/%s/" ($viewID | urlize) | relURL }}
                {{ end }}
                {{ $usedIn = $usedIn | append (dict "name" $viewTitle "type" "UI View" "link" $viewLink "icon" "laptop"
                "color" "var(--s4a-dark-violet)") }}
                {{ end }}
                {{ end }}

            </div>
            <!-- End Main Column -->

        </div>
        <!-- End Grid -->

        <!-- Full-width Footer Section -->
        {{ if gt (len $usedIn) 0 }}
        <div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
            <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Usage References</h2>
            <p class="uk-text-small uk-text-muted">This attribute is referenced in the following contexts:</p>
            <ul class="uk-list uk-list-divider uk-text-small">
                {{ range $usedIn }}
                <li>
                    <a href="{{ .link }}" class="uk-link-toggle uk-flex uk-flex-middle">
                        <span class="uk-margin-small-right" uk-icon="icon: {{ .icon }}"
                            style="color: {{ .color }}"></span>
                        <div>
                            <div class="uk-text-bold">{{ .name }}</div>
                            <div class="uk-text-meta" style="font-size: 0.8em;">{{ .type }}</div>
                        </div>
                    </a>
                </li>
                {{ end }}
            </ul>
        </div>
        {{ end }}

        <!-- Data Lineage Map -->
        {{ if gt (len $usedIn) 0 }}
        {{ partial "lineage-map.html" (dict "Context" . "UsedIn" $usedIn) }}
        {{ end }}

    </div>
</div>
{{ else }}
                <!-- Error message if attribute data not found -->
                <div class="uk-section">
                    <div class="uk-container">
                        <div class="uk-alert uk-alert-danger">
                            <h3>Attribute Not Found</h3>
                            <p>The requested attribute could not be loaded from the data registry.</p>
                            <p><a href="{{ `attributes` | relURL }}">‚Üê Back to Attributes</a></p>
                        </div>
                    </div>
                </div>
                {{ end }}

                {{ end }}