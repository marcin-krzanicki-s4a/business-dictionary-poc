<div class="uk-card uk-card-default uk-card-body content-card uk-margin-bottom">
    <h2 class="uk-h3" style="color: var(--s4a-light-violet);">Data Lineage Map</h2>
    <div class="mermaid uk-text-center">
        flowchart LR
        %% Global Styles from browse-all.html
        classDef object fill:#EB0045,color:white,stroke:#333,stroke-width:2px;
        classDef perspective fill:#31006F,color:white,stroke:#333,stroke-width:2px;
        classDef view fill:#201747,color:white,stroke:#333,stroke-width:2px;
        classDef attribute fill:#fff,stroke:#999,stroke-dasharray: 5 5,color:#333;

        %% Additional styles for local diagrams
        classDef system fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1;
        classDef role fill:#e0f2f1,stroke:#00695c,color:#00695c,stroke-width:1px;

        {{ $page := .Context }}
        {{ $section := $page.Section }}

        {{ if eq $section "objects" }}
        {{/* --- OBJECT LINEAGE --- */}}
        {{ $objectID := $page.File.BaseFileName }}
        {{ $objectData := index site.Data.objects $objectID }}

        {{ $safeObjectName := $objectData.Name | replaceRE "[^a-zA-Z0-9]" "" }}
        object["(Business Object)<br />{{ $objectData.Name | htmlEscape }}"]:::object

        %% System of Record (Simulated)
        system[("System of Record<br />(e.g. SAP/Amadeus)")]:::system
        {{ if not $objectData.CoreAttributes }}
        system -.-> object
        {{ end }}

        %% Core Attributes (Upstream)
        {{ if $objectData.CoreAttributes }}
        subgraph Attributes
        direction TB
        {{ range $objectData.CoreAttributes }}
        {{ $safeAttrName := .Name | replaceRE "[^a-zA-Z0-9]" "" }}
        attr_{{ $safeAttrName }}["(Attribute)<br />{{ .Name | htmlEscape }}"]:::attribute
        attr_{{ $safeAttrName }} -.-> object
        system -.-> attr_{{ $safeAttrName }}
        {{ $attrPage := site.GetPage (printf "/attributes/%s" .Name) }}
        {{ if $attrPage }}
        click attr_{{ $safeAttrName }} "{{ $attrPage.RelPermalink }}"
        {{ end }}
        {{ end }}
        end
        style Attributes fill:none,stroke:#999,stroke-dasharray:5 5
        {{ end }}

        %% Related Objects (Relationships)
        {{ if $objectData.CoreRelationships }}
        {{ range $objectData.CoreRelationships }}
        {{ $relatedObjName := .object }}
        {{ $safeRelObjName := $relatedObjName | replaceRE "[^a-zA-Z0-9]" "" }}
        {{ $relType := .type }}
        rel_{{ $safeRelObjName }}["(Business Object)<br />{{ $relatedObjName | htmlEscape }}"]:::object
        {{ if or (eq $relType "has-one") (eq $relType "has-many") (eq $relType "has-many (transient)") }}
        object -.->|"{{ $relType | htmlEscape }}"| rel_{{ $safeRelObjName }}
        {{ else }}
        rel_{{ $safeRelObjName }} -.->|"{{ $relType | htmlEscape }}"| object
        {{ end }}
        click rel_{{ $safeRelObjName }} "{{ (printf "objects/%s" ($relatedObjName | lower)) | relURL }}"
        {{ end }}
        {{ end }}

        %% Perspectives (Downstream)
        {{ if $objectData.SystemPerspectives }}
        {{ range $sysName, $sysData := $objectData.SystemPerspectives }}
        {{ $safeSysName := $sysName | replaceRE "[^a-zA-Z0-9]" "" }}
        persp_{{ $safeSysName }}["(Perspective)<br />{{ $sysName | htmlEscape }}"]:::perspective
        object -.-> persp_{{ $safeSysName }}

        %% Link to perspective page if possible
        {{ $perspectivePage := "" }}
        {{ range where site.RegularPages "Section" "perspectives" }}
        {{ if and (eq .Params.object_id $objectID) (eq .Params.perspective_id $sysName) }}
        click persp_{{ $safeSysName }} "{{ .RelPermalink }}"
        {{ end }}
        {{ end }}

        {{ end }}
        {{ end }}

        {{ else if eq $section "views" }}
        {{/* --- VIEW LINEAGE --- */}}
        {{ $viewID := $page.File.BaseFileName }}
        {{ $viewData := index site.Data.views $viewID }}

        {{ $safeViewName := $viewID | replaceRE "[^a-zA-Z0-9]" "" }}
        view["(UI View)<br />{{ $page.Title | htmlEscape }}"]:::view

        %% Upstream Attributes (Sample)
        {{ if $viewData.IncludedAttributes }}
        subgraph DataElements["Data Elements"]
        direction TB
        {{ range $viewData.IncludedAttributes }}
        {{ $attrName := "" }}
        {{ if reflect.IsMap . }}{{ $attrName = .Name }}{{ else }}{{ $attrName = . }}{{ end }}
        {{ $safeAttrName := $attrName | replaceRE "[^a-zA-Z0-9]" "" }}
        attr_{{ $safeAttrName }}["(Attribute)<br />{{ $attrName | htmlEscape }}"]:::attribute
        attr_{{ $safeAttrName }} -.-> view
        {{ $attrPage := site.GetPage (printf "/attributes/%s" $attrName) }}
        {{ if $attrPage }}
        click attr_{{ $safeAttrName }} "{{ $attrPage.RelPermalink }}"
        {{ end }}
        {{ end }}
        end
        style DataElements fill:none,stroke:#999,stroke-dasharray:5 5
        {{ end }}

        %% Downstream Roles
        {{ if $viewData.AccessRules }}
        {{ range $viewData.AccessRules }}
        {{ $roleName := "" }}
        {{ if reflect.IsMap . }}{{ $roleName = .Role | default .userRole }}{{ else }}{{ $roleName = . }}{{ end }}
        {{ $safeRoleName := $roleName | replaceRE "[^a-zA-Z0-9]" "" }}
        role_{{ $safeRoleName }}("(User Role)<br />{{ $roleName | htmlEscape }}"):::role
        view -.-> role_{{ $safeRoleName }}
        {{ end }}
        {{ end }}

        {{ else if eq $section "perspectives" }}
        {{/* --- PERSPECTIVE LINEAGE --- */}}
        {{ $objectID := $page.Params.object_id }}
        {{ $perspectiveID := $page.Params.perspective_id }}
        {{ $objectData := index site.Data.objects $objectID }}
        {{ $sysData := index $objectData.SystemPerspectives $perspectiveID }}

        {{ $safePerspName := $perspectiveID | replaceRE "[^a-zA-Z0-9]" "" }}
        persp["(Perspective)<br />{{ $perspectiveID | htmlEscape }}"]:::perspective

        %% Upstream Object
        {{ $safeObjectName := $objectData.Name | replaceRE "[^a-zA-Z0-9]" "" }}
        object["(Canonical Object)<br />{{ $objectData.Name | htmlEscape }}"]:::object
        object -.-> persp
        click object "{{ `objects/` | relURL }}{{ $objectID | lower }}/"

        %% Extended Attributes (Perspective Specific)
        {{ if $sysData.RelevantAttributes }}
        subgraph ExtendedAttributes["Extended Attributes"]
        direction TB
        {{ range $sysData.RelevantAttributes }}
        {{ $attrName := .Name }}
        {{ $safeAttrName := $attrName | replaceRE "[^a-zA-Z0-9]" "" }}
        attr_{{ $safeAttrName }}["(Attribute)<br />{{ $attrName | htmlEscape }}"]:::attribute
        attr_{{ $safeAttrName }} -.-> persp
        {{ $attrPage := site.GetPage (printf "/attributes/%s" $attrName) }}
        {{ if $attrPage }}
        click attr_{{ $safeAttrName }} "{{ $attrPage.RelPermalink }}"
        {{ end }}
        {{ end }}
        end
        style ExtendedAttributes fill:none,stroke:#999,stroke-dasharray:5 5
        {{ end }}

        %% Downstream Views
        {{ if $sysData.ViewsUsed }}
        {{ range $sysData.ViewsUsed }}
        {{ $viewID := .ref }}
        {{ $safeViewName := $viewID | replaceRE "[^a-zA-Z0-9]" "" }}
        view_{{ $safeViewName }}["(UI View)<br />{{ $viewID | htmlEscape }}"]:::view
        view_{{ $safeViewName }} -.-> persp
        {{ $viewPage := site.GetPage (printf "/views/%s" $viewID) }}
        {{ if $viewPage }}
        click view_{{ $safeViewName }} "{{ $viewPage.RelPermalink }}"
        {{ else }}
        click view_{{ $safeViewName }} "{{ `views/` | relURL }}{{ $viewID | urlize }}/"
        {{ end }}
        {{ end }}
        {{ end }}

        {{ else if eq $section "attributes" }}
        {{/* --- ATTRIBUTE LINEAGE --- */}}
        {{ $attributeID := $page.File.BaseFileName }}
        {{ $attributeData := index site.Data.attributes $attributeID }}
        {{ $usedIn := .UsedIn }}

        {{ $safeName := $attributeData.name | replaceRE "[^a-zA-Z0-9]" "" }}
        root["(Attribute)<br />{{ $attributeData.name | htmlEscape }}"]:::attribute

        {{ if $page.Params.sourceSystem }}
        source[("(System)<br />{{ $page.Params.sourceSystem | htmlEscape }}")]:::system
        source -.-> root
        {{ end }}

        {{ range $index, $item := $usedIn }}
        {{ $itemName := $item.name | default "Unnamed Node" }}
        {{ $safeItemName := $itemName | replaceRE "[^a-zA-Z0-9]" "" }}
        node{{ $index }}["({{ $item.type }})<br />{{ $itemName | htmlEscape }}"]
        root -.-> node{{ $index }}

        {{ if eq $item.type "Business Object" }}
        class node{{ $index }} object
        {{ else if eq $item.type "Perspective" }}
        class node{{ $index }} perspective
        {{ else if eq $item.type "UI View" }}
        class node{{ $index }} view
        {{ end }}

        click node{{ $index }} "{{ $item.link }}"
        {{ end }}

        {{ end }}
    </div>
</div>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: 'neutral',
        securityLevel: 'loose',
        flowchart: { curve: 'basis' }
    });
</script>